<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="site-base" content="/islamic-kids-app">
  <title>Your Progress | Teen Deen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600&display=swap">
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffd166">
  <link rel="apple-touch-icon" href="assets/icon.svg">
  <script src="assets/base-path.js"></script>
</head>
<body data-page="progress">
  <header class="site-header">
    <nav class="navbar">
      <div class="navbar-brand">Teen Deen</div>
      <nav class="navbar-nav" aria-label="Primary navigation">
        <a href="./" class="nav-pill">Home</a>
        <a href="lessons/" class="nav-pill">Short Lessons</a>
        <a href="teen-issues.html" class="nav-pill">Teen Issues</a>
        <a href="parents.html" class="nav-pill">Parents</a>
        <a href="about.html" class="nav-pill">About</a>
      </nav>
      <button class="navbar-hamburger" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="navbar-drawer-menu">
        <span>
          <div></div>
        </span>
      </button>
      <div class="navbar-right">
        <a href="lessons/" class="cta-btn">Continue Learning</a>
      </div>
    </nav>

    <!-- Mobile Navigation Drawer -->
    <div class="navbar-drawer" id="navbar-drawer-menu" role="dialog" aria-modal="true" aria-label="Navigation menu">
      <div class="navbar-drawer-content">
        <div class="navbar-drawer-header">
          <span style="font-weight: 600; color: var(--color-text);">Menu</span>
          <button class="navbar-drawer-close" aria-label="Close menu">‚úï</button>
        </div>
        <nav class="navbar-drawer-nav" aria-label="Primary navigation">
          <a href="./" class="nav-pill">Home</a>
          <a href="lessons/" class="nav-pill">Short Lessons</a>
          <a href="teen-issues.html" class="nav-pill">Teen Issues</a>
          <a href="parents.html" class="nav-pill">Parents</a>
          <a href="about.html" class="nav-pill">About</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero">
      <div class="hero-content">
        <h1 class="hero-title">Your Progress</h1>
        <p class="hero-subtitle">Track your learning journey and celebrate achievements</p>
      </div>
    </section>

    <!-- TODAY'S QUEST -->
    <section class="content-section" id="quest-section">
      <div id="daily-quest-container"></div>
    </section>

    <!-- STATS OVERVIEW -->
    <section class="content-section">
      <div class="section-header">
        <h2 class="section-title">Overview</h2>
        <button id="share-progress-btn" class="cta-btn" style="font-size: 0.95rem;">Share Progress</button>
      </div>
      <div class="cards-grid">
        <div class="card" style="background: linear-gradient(135deg, #fff7ec 0%, #ffefd5 100%); border-left: 4px solid var(--color-primary);">
          <h3 style="margin: 0 0 8px 0; color: var(--color-text-muted); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Level</h3>
          <p style="margin: 0; font-size: 3em; font-weight: 700; color: var(--color-primary);" id="stat-level">1</p>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #fff7ec 0%, #ffefd5 100%); border-left: 4px solid var(--color-accent);">
          <h3 style="margin: 0 0 8px 0; color: var(--color-text-muted); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Total XP</h3>
          <p style="margin: 0; font-size: 3em; font-weight: 700; color: var(--color-accent);" id="stat-xp">0</p>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #fff7ec 0%, #ffefd5 100%); border-left: 4px solid #ef476f;">
          <h3 style="margin: 0 0 8px 0; color: var(--color-text-muted); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Current Streak</h3>
          <p style="margin: 0; font-size: 3em; font-weight: 700; color: #ef476f;" id="stat-streak">0</p>
          <p style="margin: 8px 0 0 0; font-size: 0.9em; color: var(--color-text-muted);">days</p>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #fff7ec 0%, #ffefd5 100%); border-left: 4px solid #118ab2;">
          <h3 style="margin: 0 0 8px 0; color: var(--color-text-muted); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Completed</h3>
          <p style="margin: 0; font-size: 3em; font-weight: 700; color: #118ab2;" id="stat-completed">0</p>
          <p style="margin: 8px 0 0 0; font-size: 0.9em; color: var(--color-text-muted);">lessons</p>
        </div>
      </div>
      
      <!-- SHARE MODAL (hidden by default) -->
      <div id="share-modal" style="display: none; margin-top: 24px; padding: 20px; background: var(--color-surface); border: 2px solid var(--color-primary); border-radius: var(--radius-lg);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="margin: 0; font-size: 1.25rem;">Share Your Progress</h3>
          <button id="close-share-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 4px 8px; color: var(--color-text-muted);" aria-label="Close">√ó</button>
        </div>
        <p id="share-message" style="margin: 16px 0; padding: 16px; background: white; border-radius: var(--radius-md); font-size: 0.95rem; line-height: 1.6; color: var(--color-text);"></p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px;">
          <button id="copy-progress-btn" class="btn-inline" style="flex: 1; min-width: 140px;">üìã Copy Message</button>
          <a id="sms-progress-link" href="#" class="btn-inline" style="flex: 1; min-width: 140px; text-decoration: none;">üí¨ Text (SMS)</a>
          <a id="email-progress-link" href="#" class="btn-inline" style="flex: 1; min-width: 140px; text-decoration: none;">‚úâÔ∏è Email</a>
        </div>
        <p id="copy-feedback" style="margin-top: 12px; font-size: 0.875rem; color: var(--color-accent); text-align: center; display: none;">‚úì Copied to clipboard!</p>
      </div>
    </section>

    <!-- BADGES -->
    <section class="content-section">
      <div class="section-header">
        <h2 class="section-title">Badges</h2>
      </div>
      <div id="badges-container">
        <div class="card">
          <p style="text-align: center; color: var(--color-text-muted);">Complete lessons to earn badges!</p>
        </div>
      </div>
    </section>

    <!-- COMPLETED LESSONS -->
    <section class="content-section">
      <div class="section-header">
        <h2 class="section-title">Completed Lessons</h2>
      </div>
      <div id="completed-lessons-container">
        <div class="card">
          <p style="text-align: center; color: var(--color-text-muted);">No lessons completed yet. Start your first lesson!</p>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="content-section">
      <div class="section-header">
        <h2 class="section-title">Settings</h2>
      </div>
      <div class="card">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; padding: 12px 0;">
          <input type="checkbox" id="animations-toggle" style="width: 20px; height: 20px; cursor: pointer;" />
          <div>
            <strong style="display: block; margin-bottom: 4px;">Celebration Animations</strong>
            <span style="font-size: 0.9em; color: var(--color-text-muted);">Show confetti when you achieve milestones</span>
          </div>
        </label>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <p>
        <a href="lessons/" style="color: inherit; margin: 0 8px;">Short Lessons</a> ‚Ä¢ 
        <a href="teen-issues.html" style="color: inherit; margin: 0 8px;">Teen Issues</a> ‚Ä¢ 
        <a href="parents.html" style="color: inherit; margin: 0 8px;">Parents</a> ‚Ä¢ 
        <a href="about.html" style="color: inherit; margin: 0 8px;">About</a>
      </p>
      <p style="margin-top: 8px; font-size: 0.875rem; opacity: 0.7;">Privacy-first. Ad-free. No tracking.</p>
    </div>
  </footer>

  <script src="assets/progress.js"></script>
  <script src="assets/confetti.js"></script>
  <script src="assets/quests.js"></script>
  <script src="assets/mobile-nav.js"></script>
  <script>
    (function() {
      'use strict';

      // Wait for modules to load
      window.addEventListener('DOMContentLoaded', async () => {
        // Load progress stats
        if (window.TeenDeenProgress) {
          const stats = window.TeenDeenProgress.getStats();
          
          document.getElementById('stat-level').textContent = stats.level;
          document.getElementById('stat-xp').textContent = stats.xp;
          document.getElementById('stat-streak').textContent = stats.streak.current;
          document.getElementById('stat-completed').textContent = stats.completedCount;

          // Render badges
          if (stats.badges.length > 0) {
            const badgesHTML = stats.badges.map(badge => `
              <div class="card" style="text-align: center;">
                <div style="font-size: 3em; margin-bottom: 8px;">${badge.icon}</div>
                <h3 style="margin: 0 0 4px 0; font-size: 1.1em; color: var(--color-text);">${badge.name}</h3>
                <p style="margin: 0; font-size: 0.9em; color: var(--color-text-muted);">${badge.desc}</p>
                <p style="margin: 8px 0 0 0; font-size: 0.8em; color: var(--color-text-muted);">
                  ${new Date(badge.earnedAt).toLocaleDateString()}
                </p>
              </div>
            `).join('');
            document.getElementById('badges-container').innerHTML = `<div class="cards-grid">${badgesHTML}</div>`;
          }

          // Render completed lessons
          if (stats.completedCount > 0) {
            try {
              const scores = JSON.parse(localStorage.getItem('lessonScores') || '{}');
              const completedHTML = stats.completedCount > 0 
                ? Object.entries(scores).map(([lessonId, data]) => {
                    const isPerfect = data.score === data.total;
                    return `
                      <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                          <div style="flex: 1;">
                            <h3 style="margin: 0 0 8px 0; font-size: 1.1em;">${lessonId}</h3>
                            <p style="margin: 0; font-size: 0.9em; color: var(--color-text-muted);">
                              Score: ${data.score}/${data.total}
                              ${isPerfect ? '<strong style="color: var(--color-accent);">‚úì Perfect!</strong>' : ''}
                            </p>
                          </div>
                          <a href="lessons/lesson.html?id=${lessonId}" class="btn-inline">Review</a>
                        </div>
                      </div>
                    `;
                  }).join('')
                : '<div class="card"><p style="text-align: center; color: var(--color-text-muted);">No lessons completed yet.</p></div>';
              
              document.getElementById('completed-lessons-container').innerHTML = completedHTML;
            } catch (err) {
              console.warn('[Progress] Error rendering completed lessons:', err);
            }
          }
        }

        // Load daily quest
        if (window.TeenDeenQuests) {
          await window.TeenDeenQuests.loadQuests();
          window.TeenDeenQuests.renderQuest('#daily-quest-container');
        }

        // Settings
        const animationsToggle = document.getElementById('animations-toggle');
        if (window.TeenDeenConfetti) {
          animationsToggle.checked = window.TeenDeenConfetti.enabled;
          animationsToggle.addEventListener('change', (e) => {
            window.TeenDeenConfetti.setEnabled(e.target.checked);
          });
        }

        // Share Progress functionality
        const shareBtn = document.getElementById('share-progress-btn');
        const shareModal = document.getElementById('share-modal');
        const closeModal = document.getElementById('close-share-modal');
        const copyBtn = document.getElementById('copy-progress-btn');
        const shareMessageEl = document.getElementById('share-message');
        const copyFeedback = document.getElementById('copy-feedback');
        const smsLink = document.getElementById('sms-progress-link');
        const emailLink = document.getElementById('email-progress-link');

        function generateShareMessage() {
          const stats = window.TeenDeenProgress ? window.TeenDeenProgress.getStats() : {
            completedCount: 0,
            xp: 0,
            streak: { current: 0 }
          };

          if (stats.completedCount === 0) {
            return "I'm starting Teen Deen and working through lessons to strengthen my faith and character. üåü";
          }

          const parts = [];
          parts.push("üìö Teen Deen Progress Update");
          parts.push("");
          parts.push(`‚úì ${stats.completedCount} lesson${stats.completedCount !== 1 ? 's' : ''} completed`);
          parts.push(`‚≠ê ${stats.xp} XP earned`);
          if (stats.streak.current > 0) {
            parts.push(`üî• ${stats.streak.current} day streak`);
          }
          parts.push("");
          parts.push("I've been learning and making progress. üåü");
          
          return parts.join("\n");
        }

        shareBtn.addEventListener('click', async () => {
          const message = generateShareMessage();
          shareMessageEl.textContent = message;

          // Try Web Share API first
          if (navigator.share) {
            try {
              await navigator.share({
                title: 'Teen Deen Progress',
                text: message,
                url: window.location.origin + (window.withBase ? window.withBase('') : '/islamic-kids-app/')
              });
              return; // Successfully shared, exit
            } catch (err) {
              if (err.name !== 'AbortError') {
                console.log('Share API failed, showing fallback:', err);
              } else {
                return; // User cancelled
              }
            }
          }

          // Fallback: show modal
          shareModal.style.display = 'block';
          copyFeedback.style.display = 'none';

          // Setup SMS link
          const smsBody = encodeURIComponent(message);
          smsLink.href = `sms:?&body=${smsBody}`;

          // Setup Email link
          const emailSubject = encodeURIComponent('Teen Deen Progress Update');
          const emailBody = encodeURIComponent(message);
          emailLink.href = `mailto:?subject=${emailSubject}&body=${emailBody}`;
        });

        closeModal.addEventListener('click', () => {
          shareModal.style.display = 'none';
          copyFeedback.style.display = 'none';
        });

        copyBtn.addEventListener('click', async () => {
          const message = shareMessageEl.textContent;
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(message);
            } else {
              // Fallback for older browsers
              const textarea = document.createElement('textarea');
              textarea.value = message;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
            }
            copyFeedback.style.display = 'block';
            setTimeout(() => {
              copyFeedback.style.display = 'none';
            }, 3000);
          } catch (err) {
            console.error('Copy failed:', err);
            alert('Could not copy to clipboard. Please select and copy the text manually.');
          }
        });
      });
    })();
  </script>
</body>
</html>
